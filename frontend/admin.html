<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="https://www.ouviescrevi.pt/public/logos/ouviescreviicon.png" type="image/png">
  <title>Admin | Ouviescrevi</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #333;
      padding: 15px 30px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
    }
    main {
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    form {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-top: 20px;
      max-width: 500px;
      width: 100%;
    }
    input, button {
      margin: 10px 0;
      padding: 10px;
      font-size: 1em;
      width: 100%;
    }
    .hidden { display: none; }
    #output textarea {
      width: 100%;
      height: 200px;
      margin-top: 10px;
      padding: 10px;
    }
    .btn-group button {
      margin: 5px 5px 0 0;
    }
  </style>
</head>
<body>

<header>
  <h1>Admin Ouviescrevi</h1>
</header>

<main>
  <form id="loginForm" class="hidden">
    <h2>Login de administrador</h2>
    <input type="password" id="password" placeholder="Palavra-chave" required>
    <button type="submit">Entrar</button>
  </form>

  <div id="adminContent" class="hidden">
  <button onclick="logout()" style="align-self: flex-end; margin-bottom: 10px;">Sair</button>

    <p>Transcri√ß√£o autom√°tica com IA (Whisper)</p>
    <form id="uploadForm">
      <input type="file" id="fileInput" accept="audio/*,video/*" required>
      <button type="submit">Transcrever</button>
      <button type="button" onclick="startRecording()">üé§ Gravar √Åudio</button>
      <p id="recordingStatus"></p>
    </form>

    <div id="loading" class="hidden">
      <p>üîÑ A processar transcri√ß√£o...</p>
      <div style="background:#ddd; border-radius:8px; width:100%; height:20px;">
        <div id="progressBar" style="height:100%; width:0%; background:#4caf50; border-radius:8px;"></div>
      </div>
    </div>

    <div id="output" class="hidden">
      <h3>Transcri√ß√£o:</h3>
      <textarea id="transcriptionText" readonly></textarea>
      <div class="btn-group">
        <button onclick="exportText('pdf')">Exportar PDF</button>
        <button onclick="exportText('docx')">Exportar DOCX</button>
        <button onclick="exportText('txt')">Exportar TXT</button>
        <button onclick="exportText('srt')">Exportar SRT</button>
        <button onclick="exportText('json')">Exportar JSON</button>
      </div>
    </div>
  </div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const loginForm = document.getElementById("loginForm");
  const adminContent = document.getElementById("adminContent");

  // Mostrar admin se j√° est√° autenticado
  if (localStorage.getItem("loggedIn") === "true") {
    loginForm.classList.add("hidden");
    adminContent.classList.remove("hidden");
  } else {
    loginForm.classList.remove("hidden");
  }

  loginForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const password = document.getElementById("password").value;

    if (password === "admin") {
      localStorage.setItem("loggedIn", "true");
      loginForm.classList.add("hidden");
      adminContent.classList.remove("hidden");
    } else {
      alert("Palavra-chave incorreta!");
    }
  });

  const form = document.getElementById("uploadForm");
  const loading = document.getElementById("loading");
  const progressBar = document.getElementById("progressBar");
  const output = document.getElementById("output");
  const transcriptionText = document.getElementById("transcriptionText");
  let progressInterval;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = document.getElementById("fileInput").files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    output.classList.add("hidden");
    transcriptionText.value = "";
    loading.classList.remove("hidden");
    progressBar.style.width = "0%";

    let progress = 0;
    progressInterval = setInterval(() => {
      if (progress < 90) {
        progress += Math.random() * 5;
        progressBar.style.width = progress + "%";
      }
    }, 200);

    try {
      const res = await fetch("https://api.ouviescrevi.pt/transcribe", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      clearInterval(progressInterval);
      progressBar.style.width = "100%";
      transcriptionText.value = data.formatted || data.transcription || "‚ö†Ô∏è Erro ao transcrever.";
      output.classList.remove("hidden");
    } catch (err) {
      transcriptionText.value = "‚ö†Ô∏è Erro ao transcrever.";
      output.classList.remove("hidden");
    } finally {
      loading.classList.add("hidden");
      progressBar.style.width = "0%";
    }
  });

  function exportText(type) {
    const text = transcriptionText.value;

    if (type === 'pdf') {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const textLines = doc.splitTextToSize(text, 180);
      let y = 20;
      for (let i = 0; i < textLines.length; i++) {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.text(textLines[i], 15, y);
        y += 8;
      }
      doc.save("transcricao.pdf");
    }
    else if (type === 'docx') {
      const blob = new Blob([text], { type: 'application/msword;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "transcricao.doc";
      a.click();
      URL.revokeObjectURL(url);
    }
    else if (type === 'txt') {
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "transcricao.txt";
      a.click();
      URL.revokeObjectURL(url);
    }
    else if (type === 'json') {
      const json = JSON.stringify({ transcription: text }, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "transcricao.json";
      a.click();
      URL.revokeObjectURL(url);
    }
    else if (type === 'srt') {
      const lines = text.split('\n');
      let srt = '', count = 1;
      for (let line of lines) {
        const match = line.match(/^\[(\d{2}):(\d{2})\] (.+)$/);
        if (match) {
          const [_, min, sec, content] = match;
          const start = `00:${min}:${sec},000`;
          const end = `00:${min}:${String(parseInt(sec) + 2).padStart(2, '0')},000`;
          srt += `${count}\n${start} --> ${end}\n${content}\n\n`;
          count++;
        }
      }
      const blob = new Blob([srt], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "transcricao.srt";
      a.click();
      URL.revokeObjectURL(url);
    }
  }

  let mediaRecorder;
  let audioChunks = [];

  async function startRecording() {
    const status = document.getElementById("recordingStatus");
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      status.textContent = "üïê A processar o √°udio...";
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append("file", blob, "gravacao.webm");

      output.classList.add("hidden");
      transcriptionText.value = "";
      loading.classList.remove("hidden");
      progressBar.style.width = "0%";
      status.textContent = "üîÑ A enviar para transcri√ß√£o...";

      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 90) {
          progress += Math.random() * 5;
          progressBar.style.width = progress + "%";
        }
      }, 200);

      try {
        const res = await fetch("https://api.ouviescrevi.pt/transcribe", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        clearInterval(progressInterval);
        progressBar.style.width = "100%";
        transcriptionText.value = data.formatted || data.transcription || "‚ö†Ô∏è Erro ao transcrever.";
        output.classList.remove("hidden");
        status.textContent = "";
      } catch (err) {
        transcriptionText.value = "‚ö†Ô∏è Erro ao transcrever.";
        output.classList.remove("hidden");
        status.textContent = "‚ùå Erro ao gravar.";
      }

      setTimeout(() => {
        loading.classList.add("hidden");
        progressBar.style.width = "0%";
      }, 500);
    };

    mediaRecorder.start();
    status.textContent = "üéôÔ∏è A gravar... clique novamente para terminar.";
  }
  function logout() {
  localStorage.removeItem("loggedIn");
  location.reload();
}

</script>

</body>
</html>
